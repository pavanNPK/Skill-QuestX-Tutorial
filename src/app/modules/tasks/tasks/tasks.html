<div class="page-container">
    <!-- Header -->
    <div class="tasks-header-actions">
        <div class="view-toggles">
            <button pButton icon="pi pi-list" class="p-button-text" [class.active]="currentView() === 'list'"
                (click)="toggleView('list')" pTooltip="List View" tooltipPosition="bottom"></button>
            <button pButton icon="pi pi-th-large" class="p-button-text" [class.active]="currentView() === 'board'"
                (click)="toggleView('board')" pTooltip="Board View" tooltipPosition="bottom"></button>
        </div>

        <div class="action-buttons">
            <button pButton label="Create Task" icon="pi pi-plus" class="create-btn"
                (click)="openCreateDrawer()"></button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filters-section">
        <span class="p-input-icon-left search-box">
            <i class="pi pi-search"></i>
            <input type="text" pInputText placeholder="Search tasks..." [(ngModel)]="searchText" />
        </span>

        <p-select [options]="filterStatusOptions" [(ngModel)]="filterStatus" placeholder="Status" [showClear]="true"
            class="status-filter"></p-select>

        <p-datepicker [(ngModel)]="filterDateRange" selectionMode="range" [readonlyInput]="true"
            placeholder="Date Range" class="date-filter"></p-datepicker>

        <p-select [options]="batches" [(ngModel)]="filterBatch" optionLabel="name" placeholder="Filter by Batch"
            [showClear]="true" class="batch-filter"></p-select>
    </div>

    <!-- List View -->
    @if (currentView() === 'list') {
    <div class="tasks-table-container">
        <p-table [value]="filteredTasks" [tableStyle]="{ 'min-width': '50rem' }" selectionMode="single"
            [(selection)]="selectedTask" (onRowSelect)="openTaskDetails($event.data)">
            <ng-template pTemplate="header">
                <tr>
                    <th>Task Name</th>
                    <th>Batch</th>
                    <th>Due Date</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Assigned</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-task>
                <tr [pSelectableRow]="task" class="cursor-pointer">
                    <td>
                        <div class="task-cell-content">
                            <span class="task-title">{{ task.title }}</span>
                            <span class="task-desc-truncate">{{ task.description }}</span>
                        </div>
                    </td>
                    <td>{{ task.batchName }}</td>
                    <td>{{ task.dueDate | date:'MMM d, y' }}</td>
                    <td>
                        <p-tag [value]="task.priority"
                            [severity]="task.priority === 'High' ? 'danger' : (task.priority === 'Medium' ? 'warn' : 'success')"></p-tag>
                    </td>
                    <td>
                        <span class="status-badge" [class]="task.status.toLowerCase().replace(' ', '-')">{{ task.status
                            }}</span>
                    </td>
                    <td>
                        <div class="assigned-stats">
                            <i class="pi pi-users"></i>
                            <span>{{ task.submittedCount }}/{{ task.assignedCount }} Submitted</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    }

    <!-- Board View -->
    @if (currentView() === 'board') {
    <div class="tasks-board">
        <!-- Pending Column -->
        <div class="board-column">
            <div class="column-header pending">
                <h3>Pending</h3>
                <span class="count">{{ getTasksByStatus('Pending').length }}</span>
            </div>
            <div class="column-content">
                @for (task of getTasksByStatus('Pending'); track task.id) {
                <div class="kanban-card" (click)="openTaskDetails(task)">
                    <div class="card-header">
                        <p-tag [value]="task.priority"
                            [severity]="task.priority === 'High' ? 'danger' : (task.priority === 'Medium' ? 'warn' : 'success')"
                            styleClass="mini-tag"></p-tag>
                        <span class="due-date">{{ task.dueDate | date:'MMM d' }}</span>
                    </div>
                    <h4>{{ task.title }}</h4>
                    <p class="batch-name">{{ task.batchName }}</p>
                    <div class="card-footer">
                        <div class="progress-info">
                            <span>{{ task.submittedCount }}/{{ task.assignedCount }} Submitted</span>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="board-column">
            <div class="column-header in-progress">
                <h3>In Progress</h3>
                <span class="count">{{ getTasksByStatus('In Progress').length }}</span>
            </div>
            <div class="column-content">
                @for (task of getTasksByStatus('In Progress'); track task.id) {
                <div class="kanban-card" (click)="openTaskDetails(task)">
                    <div class="card-header">
                        <p-tag [value]="task.priority"
                            [severity]="task.priority === 'High' ? 'danger' : (task.priority === 'Medium' ? 'warn' : 'success')"
                            styleClass="mini-tag"></p-tag>
                        <span class="due-date">{{ task.dueDate | date:'MMM d' }}</span>
                    </div>
                    <h4>{{ task.title }}</h4>
                    <p class="batch-name">{{ task.batchName }}</p>
                    <div class="card-footer">
                        <div class="progress-info">
                            <span>{{ task.submittedCount }}/{{ task.assignedCount }} Submitted</span>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>

        <!-- Completed Column -->
        <div class="board-column">
            <div class="column-header completed">
                <h3>Completed</h3>
                <span class="count">{{ getTasksByStatus('Completed').length }}</span>
            </div>
            <div class="column-content">
                @for (task of getTasksByStatus('Completed'); track task.id) {
                <div class="kanban-card" (click)="openTaskDetails(task)">
                    <div class="card-header">
                        <p-tag [value]="task.priority"
                            [severity]="task.priority === 'High' ? 'danger' : (task.priority === 'Medium' ? 'warn' : 'success')"
                            styleClass="mini-tag"></p-tag>
                        <span class="due-date">{{ task.dueDate | date:'MMM d' }}</span>
                    </div>
                    <h4>{{ task.title }}</h4>
                    <p class="batch-name">{{ task.batchName }}</p>
                    <div class="card-footer">
                        <div class="progress-info">
                            <span>{{ task.submittedCount }}/{{ task.assignedCount }} Submitted</span>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
    }
</div>

<!-- Create Task Drawer -->
<p-drawer [(visible)]="isCreateDrawerOpen" position="right" styleClass="create-task-drawer" [modal]="true"
    [closable]="true">
    <ng-template #header>
        <div class="create-task-drawer-header">
            <span class="create-task-drawer-title">{{ isEditing() ? 'Edit Task' : 'Create New Task' }}</span>
        </div>
    </ng-template>

    <div class="create-task-form">
        <div class="form-field">
            <label class="form-label">Task Title</label>
            <input type="text" pInputText [(ngModel)]="newTask.title" placeholder="Enter task title"
                class="form-input" />
        </div>

        <div class="form-field">
            <label class="form-label">Description</label>
            <textarea pInputTextarea [(ngModel)]="newTask.description" rows="4" placeholder="Enter task description"
                class="form-textarea"></textarea>
        </div>

        <div class="form-row form-row-2">
            <div class="form-field">
                <label class="form-label">Batch</label>
                <p-select [options]="batches" [(ngModel)]="newTask.batch" optionLabel="name" placeholder="Select Batch"
                    class="create-task-select w-full" [checkmark]="true" [showClear]="true"></p-select>
            </div>
            <div class="form-field">
                <label class="form-label">Due Date</label>
                <p-datepicker [(ngModel)]="newTask.dueDate" [showTime]="true" placeholder="Select due date"
                    appendTo="body" styleClass="form-datepicker"></p-datepicker>
            </div>
        </div>

        <div class="form-row form-row-2">
            <div class="form-field">
                <label class="form-label">Duration</label>
                <input type="text" pInputText [(ngModel)]="newTask.duration" placeholder="e.g. 2 hours"
                    class="form-input" />
            </div>
            <div class="form-field">
                <label class="form-label">Priority</label>
                <p-select [options]="priorityOptions" [(ngModel)]="newTask.priority" placeholder="Select Priority"
                    class="create-task-select w-full" [checkmark]="true" [showClear]="true"></p-select>
            </div>
        </div>

        @if (newTask.batch) {
        <div class="form-field form-field-avatars">
            <label class="form-label">Assigned Students ({{ newTask.batch.students.length }})</label>
            <div class="avatar-group-wrap">
                <p-avatarGroup>
                    @for (student of newTask.batch.students.slice(0, 5); track student.id) {
                    <p-avatar [image]="student.avatar" shape="circle" size="normal"
                        styleClass="border-2 border-white"></p-avatar>
                    }
                    @if (newTask.batch.students.length > 5) {
                    <p-avatar [label]="'+' + (newTask.batch.students.length - 5)" shape="circle" size="normal"
                        [style]="{'background-color': '#9c27b0', 'color': '#ffffff'}"></p-avatar>
                    }
                </p-avatarGroup>
            </div>
        </div>
        }
    </div>

    <ng-template #footer>
        <div class="create-task-drawer-footer">
            <button pButton label="Cancel" class="p-button-outlined p-button-secondary"
                (click)="closeCreateDrawer()"></button>
            <button pButton [label]="isEditing() ? 'Save Changes' : 'Create Task'" icon="pi pi-check"
                (click)="saveTask()" [disabled]="!newTask.title || !newTask.batch" class="create-task-btn"></button>
        </div>
    </ng-template>
</p-drawer>

<!-- Task Details Drawer -->
<p-drawer [(visible)]="isDetailsDrawerOpen" position="right" styleClass="task-details-drawer" [modal]="true"
    [closable]="true">
    <ng-template #header>
        <div class="premium-drawer-header w-full">
            <div class="title-section">
                <h2>{{ selectedTask()?.title }}</h2>
                <div class="meta-badges">
                    <p-tag [value]="selectedTask()?.priority"
                        [severity]="selectedTask()?.priority === 'High' ? 'danger' : (selectedTask()?.priority === 'Medium' ? 'warn' : 'success')"
                        class="uppercase text-[10px] font-bold tracking-wider px-2 py-0.5"></p-tag>
                </div>
            </div>
            <!-- Actions moved to footer -->
        </div>
    </ng-template>

    @if (selectedTask(); as task) {
    <div class="task-details-content h-full overflow-y-auto custom-scrollbar">

        <!-- Properties Panel -->
        <div class="properties-panel">
            <h3>Properties</h3>

            <div class="property-grid">
                <!-- Due Date -->
                <div class="property-item">
                    <label>Due Date</label>
                    <div class="value">
                        <i class="pi pi-calendar"></i>
                        <span>{{ task.dueDate | date:'medium' }}</span>
                    </div>
                </div>

                <!-- Duration -->
                <div class="property-item">
                    <label>Duration</label>
                    <div class="value">
                        <i class="pi pi-clock"></i>
                        <span>{{ task.duration }}</span>
                    </div>
                </div>

                <!-- Batch -->
                <div class="property-item">
                    <label>Batch</label>
                    <div class="value">
                        <i class="pi pi-users"></i>
                        <span>{{ task.batchName }}</span>
                    </div>
                </div>

                <!-- Description -->
                <div class="property-item">
                    <label>Description</label>
                    <p class="description-text">
                        {{ task.description }}
                    </p>
                </div>
            </div>
        </div>



        <!-- Activity Feed -->
        <div class="activity-feed">
            <div class="feed-header">
                <h3>Student Activity</h3>
                <span class="count-badge">{{ getTaskSubmissions(task).length }}</span>
            </div>

            <div class="feed-list">
                @for (sub of getTaskSubmissions(task); track sub.student.id) {
                <div class="feed-item">
                    <div class="avatar-wrapper">
                        <p-avatar [image]="sub.student.avatar" shape="circle" size="normal"></p-avatar>
                    </div>

                    <div class="feed-content">
                        <div class="top-row">
                            <span class="student-name">{{ sub.student.name }}</span>
                            <span class="timestamp">{{ sub.submittedAt ? (sub.submittedAt | date:'MMM d') : '' }}</span>
                        </div>

                        @if(sub.status === 'Submitted') {
                        <div class="status-badge submitted">
                            <i class="pi pi-check-circle" style="font-size: 0.7rem"></i>
                            <span>Submitted</span>
                        </div>
                        } @else {
                        <div class="status-badge pending">
                            <i class="pi pi-clock" style="font-size: 0.7rem"></i>
                            <span>Pending</span>
                        </div>
                        }
                    </div>

                    @if (sub.status === 'Submitted') {
                    <button pButton icon="pi pi-external-link" [text]="true" [rounded]="true" size="small"
                        class="action-btn"></button>
                    }
                </div>
                }
            </div>
        </div>
    </div>
    }

    <ng-template #footer>
        <div class="drawer-footer">
            <button pButton label="Delete Task" icon="pi pi-trash" class="p-button-outlined p-button-danger"
                (click)="confirmDelete($event)"></button>
            <button pButton label="Edit Task" icon="pi pi-pencil" class="p-button-primary"
                (click)="editTask()"></button>
        </div>
    </ng-template>
</p-drawer>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>